{
  "name": "IIF Function Tests",
  "description": "Tests for the iif() conditional function",
  "tests": [
    {
      "name": "iif - true condition",
      "expression": "iif(active, 'Active', 'Inactive')",
      "input": [
        {
          "active": true
        }
      ],
      "expected": [
        "Active"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "function:iif"
      ]
    },
    {
      "name": "iif - false condition",
      "expression": "iif(active, 'Active', 'Inactive')",
      "input": [
        {
          "active": false
        }
      ],
      "expected": [
        "Inactive"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "function:iif"
      ]
    },
    {
      "name": "iif - empty as false",
      "expression": "iif(active, 'Active', 'Inactive')",
      "input": [
        {}
      ],
      "expected": [
        "Inactive"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "empty",
        "function:iif"
      ]
    },
    {
      "name": "iif - lazy evaluation true",
      "expression": "iif(value != 0, 10 / value, 0)",
      "input": [
        {
          "value": 5
        }
      ],
      "expected": [
        2
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "lazy",
        "function:iif"
      ]
    },
    {
      "name": "iif - lazy evaluation false",
      "expression": "iif(value != 0, 10 / value, 0)",
      "input": [
        {
          "value": 0
        }
      ],
      "expected": [
        0
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "lazy",
        "function:iif"
      ]
    },
    {
      "name": "iif - with navigation",
      "expression": "iif(x > 0, x + 1, x - 1)",
      "input": [
        {
          "x": 5
        }
      ],
      "expected": [
        6
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "navigation",
        "function:iif"
      ]
    },
    {
      "name": "iif - negative value",
      "expression": "iif(x > 0, x + 1, x - 1)",
      "input": [
        {
          "x": -5
        }
      ],
      "expected": [
        -6
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "navigation",
        "function:iif"
      ]
    },
    {
      "name": "iif - two parameter form returns empty when false",
      "expression": "iif(false, 'true-result').empty()",
      "input": [],
      "expected": [
        true
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "two-parameter",
        "spec",
        "function:iif"
      ]
    },
    {
      "name": "iif - non-boolean criteria returns empty",
      "expression": "iif('non boolean criteria', 'true-result', 'false-result')",
      "input": [],
      "expected": [],
      "tags": [
        "function",
        "conditional",
        "iif",
        "non-boolean",
        "spec",
        "function:iif"
      ]
    },
    {
      "name": "iif - empty input context preservation",
      "expression": "{}.iif(true, 'true-result', 'false-result')",
      "input": [],
      "expected": [
        "true-result"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "context",
        "spec",
        "function:iif"
      ]
    },
    {
      "name": "iif - single value context preservation",
      "expression": "('item').iif(true, 'true-result', 'false-result')",
      "input": [],
      "expected": [
        "true-result"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "context",
        "spec",
        "function:iif"
      ]
    },
    {
      "name": "iif - $this in true branch",
      "expression": "('context').iif(true, select($this), 'false-result')",
      "input": [],
      "expected": [
        "context"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "context",
        "$this",
        "spec",
        "function:iif",
        "function:select"
      ]
    },
    {
      "name": "iif - $this in condition",
      "expression": "('context').iif($this = 'context','true-result', 'false-result')",
      "input": [{}],
      "expected": [
        "true-result"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "context",
        "$this",
        "spec",
        "function:iif"
      ]
    },
    {
      "name": "iif - lazy evaluation with true condition",
      "expression": "iif(true, true, (1 | 2).toString())",
      "input": [],
      "expected": [
        true
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "lazy",
        "spec",
        "function:iif"
      ]
    },
    {
      "name": "iif - lazy evaluation with false condition",
      "expression": "iif(false, (1 | 2).toString(), true)",
      "input": [],
      "expected": [
        true
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "lazy",
        "spec",
        "function:iif"
      ]
    },
    {
      "name": "iif - $this refers to input collection",
      "expression": "(1).iif($this.count() = 1, 'one item', 'not one item')",
      "input": [],
      "expected": [
        "one item"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "context",
        "$this",
        "collection",
        "function:iif",
        "function:count"
      ]
    },
    {
      "name": "iif - $this in branches refers to input",
      "expression": "('test').iif(true, $this, 'other')",
      "input": [],
      "expected": [
        "test"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "context",
        "$this",
        "branches",
        "function:iif"
      ]
    },
    {
      "name": "iif - with exists() condition",
      "expression": "Patient.name.exists().iif($this, 'has name', 'no name')",
      "input": [
        {
          "resourceType": "Patient",
          "name": [
            {
              "given": ["John"],
              "family": "Doe"
            }
          ]
        }
      ],
      "expected": [
        "has name"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "exists",
        "real-world",
        "function:iif",
        "function:exists"
      ]
    },
    {
      "name": "iif - with empty() condition",
      "expression": "Patient.telecom.empty().iif($this, 'no contact', 'has contact')",
      "input": [
        {
          "resourceType": "Patient",
          "name": [
            {
              "given": ["John"],
              "family": "Doe"
            }
          ]
        }
      ],
      "expected": [
        "no contact"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "empty",
        "real-world",
        "function:iif",
        "function:empty"
      ]
    },
    {
      "name": "iif - chained conditions",
      "expression": "iif(Patient.name.exists(), iif(Patient.name.given.exists(), 'has given name', 'no given name'), 'no name at all')",
      "input": [
        {
          "resourceType": "Patient",
          "name": [
            {
              "given": ["John"],
              "family": "Doe"
            }
          ]
        }
      ],
      "expected": [
        "has given name"
      ],
      "tags": [
        "function",
        "conditional",
        "iif",
        "nested",
        "chain",
        "real-world",
        "function:iif",
        "function:exists"
      ]
    },
    {
      "name": "iif - error on multiple item input",
      "expression": "('item1' | 'item2').iif(true, 'true-result', 'false-result')",
      "input": [],
      "expected": [],
      "error": {
        "type": "Error",
        "message": "iif\\(\\) can only be used on single item or empty collections"
      },
      "tags": [
        "function",
        "conditional",
        "iif",
        "error",
        "multiple",
        "cardinality",
        "function:iif"
      ]
    }
  ]
}